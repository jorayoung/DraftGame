<!DOCTYPE html>
<html>
<head>
<link rel="icon" href="logo.png" type="image/x-icon">
<title>Драфт</title>
<style>
  body {
    margin: 0;
    padding: 0;
    min-height: 100vh;
    background: url('background.png') no-repeat center center fixed;
    background-size: cover;
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: 'Arial', sans-serif;
    color: white;
    position: relative;
  }

  body::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
     background: rgba(30, 30, 30, 0.5);
    z-index: -1;
  }

  .position-container {
    display: flex;
    flex-direction: column;
    margin: 25px 0;
    width: 90%;
    max-width: 1000px;
    background: linear-gradient(145deg, rgba(0,0,0,0.8), rgba(40,40,40,0.8));
    padding: 20px;
    border-radius: 15px;
    border: 1px solid rgba(0, 191, 255, 0.2);
    box-shadow: 0 0 15px rgba(0,0,0,0.5),
               0 0 6px rgba(0, 191, 255, 0.1) inset;
  }

  .players-row {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 25px;
    padding: 10px 0;
  }

  .player-circle {
    width: 130px;
    height: 130px;
    border-radius: 50%;
    border: 2px solid #000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    transform-style: preserve-3d;
  }

  .player-circle::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, 
      transparent, 
      rgba(255,255,255,0.1), 
      transparent);
    transform: rotate(45deg);
    transition: 0.5s;
    opacity: 0;
  }

  .player-circle:hover::before {
    opacity: 1;
    animation: playerShine 1.5s;
  }

  @keyframes playerShine {
    0% { transform: translateX(-50%) rotate(45deg); }
    100% { transform: translateX(150%) rotate(45deg); }
  }

  .player-rating {
    font-size: 58px;
    font-weight: 800;
    color: white;
    text-shadow: 2px 2px 6px rgba(0,0,0,0.8);
    position: absolute;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 2;
  }

  .player-nickname {
    font-size: 16px;
    font-weight: 500;
    color: white;
    position: absolute;
    top: 70%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    text-align: center;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding: 0 5px;
    z-index: 2;
  }

  .selected {
    border-color: #00ff00;
    box-shadow: 0 0 12px #00ff00,
                0 0 20px rgba(0, 255, 0, 0.1);
    transform: scale(1.06);
  }

  .bronze { background: linear-gradient(135deg, #cd7f32 0%, #a97142 100%); }
  .silver { background: linear-gradient(135deg, #c0c0c0 0%, #909090 100%); }
  .gold { background: linear-gradient(135deg, #ffd700 0%, #daa520 100%); }
  .red {
    background: linear-gradient(135deg, #ff0000 0%, #8b0000 100%);
    box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
}

  #matchOverlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px);
  }

  #matchPopup {
    background: linear-gradient(145deg, #222, #1a1a1a);
    padding: 20px;
    border-radius: 15px;
    width: 95%;
    max-width: 700px;
    box-shadow: 0 0 20px rgba(0,0,0,0.6),
                0 0 8px rgba(0, 191, 255, 0.15);
    border: 1px solid rgba(0, 191, 255, 0.1);
    display: flex;
    flex-direction: column;
    max-height: 90vh;
    box-sizing: border-box;

}
  }

  .team-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 0 10px;
  }

  .team-logo {
    width: 150px;
    height: 150px;
    object-fit: contain;
    filter: drop-shadow(0 0 8px rgba(0, 191, 255, 0.3));
  }

  .team-name-display {
    font-size: 16px;
    font-weight: 600;
    margin-top: 8px;
    color: #00bfff;
    text-shadow: 0 0 6px rgba(0, 191, 255, 0.3);
    white-space: nowrap;
  }

  #startButton {
    display: none;
    margin: 25px auto 0;
    padding: 14px 35px;
    font-size: 18px;
    font-weight: 600;
    background: linear-gradient(135deg, #0066cc, #00bfff);
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    position: relative;
    overflow: hidden;
  }

  #startButton::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255,255,255,0.12),
      transparent
    );
    transition: 0.5s;
  }

  #startButton:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.3);
  }

  #startButton:hover::before {
    left: 100%;
  }

  h2, h3 {
    text-align: center;
    margin: 0 0 20px;
    color: #00bfff;
    text-shadow: 0 0 10px rgba(0, 191, 255, 0.3);
    font-size: 1.4em;
  }

  .vs-container {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 15px 0;
    gap: 20px;
    flex-wrap: nowrap;
    width: 100%;
  }

  .score {
    font-size: 28px;
    font-weight: 800;
    margin: 12px 0;
    color: #fff;
    text-align: center;
    width: 100%;
    text-shadow: 0 0 10px rgba(0, 191, 255, 0.5);
  }

  .final-banner {
    background: linear-gradient(135deg, gold, #daa520);
    color: #000;
    padding: 8px 20px;
    border-radius: 6px;
    font-weight: 700;
    margin: 0 auto 15px;
    width: fit-content;
    box-shadow: 0 0 12px rgba(255,215,0,0.3);
    font-size: 14px;
  }

  .match-time {
    font-size: 16px;
    font-weight: 500;
    margin: 0 auto 10px;
    text-align: center;
    width: fit-content;
    color: #00bfff;
  }

  #eventsContainer {
    max-height: 118px;
    overflow-y: auto;
    overflow-x: hidden;
    margin: 1px 0;
    padding-right: 5px;
    width: calc(100% - 5px);
  }

  #eventsContainer::-webkit-scrollbar {
    width: 5px;
    background-color: rgba(0,0,0,0.25);
    border-radius: 2px;
  }

  #eventsContainer::-webkit-scrollbar-thumb {
    background-color: #00bfff;
    border-radius: 2px;
  }

  .goal-event {
    font-size: 13px;
    margin: 2px 0;
    padding: 4px 8px;
    border-radius: 4px;
    animation: goalFlash 0.8s;
    background: rgba(0,0,0,0.25);
    border-left: 3px solid;
    line-height: 1.2;
    min-height: 14px;
    display: flex;
    align-items: center;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
  }

  .user-goal {
    color: #7cfc00;
    border-color: #7cfc00;
    text-shadow: 0 0 4px rgba(124,252,0,0.25);
  }

  .opponent-goal {
    color: #ff4500;
    border-color: #ff4500;
    text-shadow: 0 0 4px rgba(255,69,0,0.25);
  }

  @keyframes goalFlash {
    0% { transform: scale(1.05); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
  }

  .match-buttons-container {
    margin-top: auto;
    padding-top: 15px;
  }

  #playButton, #backToMenuButton {
    padding: 12px 28px;
    font-size: 16px;
    font-weight: 600;
    background: linear-gradient(135deg, #0066cc, #00bfff);
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    display: block;
    margin: 8px auto;
    width: fit-content;
  }

  #playButton:hover, #backToMenuButton:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.25);
  }

  #statsOverlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.97);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(6px);
  }

  #statsPopup {
    background: linear-gradient(145deg, #1a1a1a, #222);
    padding: 20px;
    border-radius: 15px;
    width: 95%;
    max-width: 600px;
    box-shadow: 0 0 20px rgba(0,0,0,0.6),
                0 0 8px rgba(0, 191, 255, 0.15);
    border: 1px solid rgba(0, 191, 255, 0.1);
  }

  .stats-title {
    text-align: center;
    font-size: 20px;
    margin-bottom: 15px;
    color: #00bfff;
    text-shadow: 0 0 10px rgba(0, 191, 255, 0.3);
  }

  .stats-table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0;
  }

  .stats-table th {
    background: linear-gradient(135deg, #0066cc, #00bfff);
    color: white;
    padding: 10px;
    font-weight: 600;
    font-size: 14px;
  }

  .stats-table td {
    padding: 8px 10px;
    background: rgba(255,255,255,0.05);
    border-bottom: 1px solid rgba(255,255,255,0.08);
    font-size: 13px;
  }

  .golden-ball {
    text-align: center;
    margin-top: 15px;
    padding: 12px;
    background: rgba(255,215,0,0.08);
    border-radius: 12px;
    border: 1px solid gold;
    box-shadow: 0 0 8px rgba(255,215,0,0.25);
  }

  .golden-ball-icon {
    font-size: 28px;
    margin-bottom: 8px;
    text-shadow: 0 0 12px gold;
  }

  #teamNameModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 3000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }

  #teamNamePopup {
    background: linear-gradient(145deg, #222, #1a1a1a);
    padding: 20px;
    border-radius: 15px;
    width: 95%;
    max-width: 450px;
    box-shadow: 0 0 20px rgba(0,0,0,0.6),
                0 0 8px rgba(0, 191, 255, 0.15);
    border: 1px solid rgba(0, 191, 255, 0.1);
  }

  #teamNameInput {
    width: 100%;
    padding: 10px;
    font-size: 14px;
    margin: 12px 0;
    border-radius: 6px;
    border: 1px solid #00bfff;
    background: rgba(0,0,0,0.4);
    color: white;
    text-align: center;
    transition: all 0.3s;
  }

  #teamNameInput:focus {
    outline: none;
    box-shadow: 0 0 8px rgba(0, 191, 255, 0.2);
  }

  #confirmTeamName {
    padding: 10px 25px;
    font-size: 14px;
    background: linear-gradient(135deg, #0066cc, #00bfff);
    color: white;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  #confirmTeamName:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 10px rgba(0,0,0,0.25);
  }

  .game-style-buttons {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin: 20px 0;
  }

  .style-button {
    padding: 8px 16px;
    font-size: 12px;
    font-weight: 600;
    border: none;
    border-radius: 18px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    background-size: 200% auto;
  }

  .style-button.defensive {
    background: linear-gradient(135deg, #4CAF50, #2E8B57);
  }

  .style-button.balanced {
    background: linear-gradient(135deg, #2196F3, #1E90FF);
  }

  .style-button.offensive {
    background: linear-gradient(135deg, #f44336, #FF4500);
  }

  .style-button.selected {
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(255,255,255,0.3),
                0 4px 10px rgba(0,0,0,0.2);
  }

  .style-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 10px rgba(0,0,0,0.25);
  }

#transferOverlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 1500;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px);
}

#transferPopup {
    background: linear-gradient(145deg, #222, #1a1a1a);
    padding: 20px;
    border-radius: 15px;
    width: 95%;
    max-width: 700px;
    box-shadow: 0 0 20px rgba(0,0,0,0.6),
                0 0 8px rgba(0, 191, 255, 0.15);
    border: 1px solid rgba(0, 191, 255, 0.1);
    display: flex;
    flex-direction: column;
    align-items: center;
}

.transfer-title {
    font-size: 24px;
    margin-bottom: 20px;
    color: #00bfff;
    text-shadow: 0 0 10px rgba(0, 191, 255, 0.3);
    text-align: center;
}

.transfer-players {
    display: flex;
    justify-content: space-between;
    width: 100%;
    margin: 20px 0;
}

.transfer-player {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 45%;
}

.transfer-player-title {
    font-size: 16px;
    margin-bottom: 10px;
    color: white;
    text-align: center;
}

.transfer-buttons {
    display: flex;
    gap: 20px;
    margin-top: 20px;
}

.transfer-button {
    padding: 12px 25px;
    font-size: 16px;
    font-weight: 600;
    background: linear-gradient(135deg, #0066cc, #00bfff);
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

.transfer-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.25);
}

.transfer-button.reject {
    background: linear-gradient(135deg, #cc3300, #ff4500);
}

.year-display {
    position: fixed;
    top: 10px;
    right: 10px;
    font-size: 14px;
    color: rgba(255, 255, 255, 0.7);
    background: rgba(0, 0, 0, 0.5);
    padding: 5px 10px;
    border-radius: 15px;
    z-index: 2000; /* Увеличьте z-index чтобы элемент был поверх всех окон */
    pointer-events: none; /* Чтобы не мешал взаимодействию с другими элементами */
}

.player-circle.bronze,
.player-circle.silver,
.player-circle.gold,
.player-circle.red {
    background-size: cover !important;
    background-repeat: no-repeat !important;
}

/* Добавляем в секцию style */
#teamSquadPanel {
    background: rgba(0, 0, 0, 0.5);
    border-radius: 10px;
    padding: 10px;
    margin-bottom: 15px;
    border: 1px solid rgba(0, 191, 255, 0.2);
    max-height: 200px;
    overflow-y: auto;
}

#teamSquadPanel h3 {
    text-align: center;
    margin: 0 0 10px;
    color: #00bfff;
    font-size: 16px;
}

#teamSquadPlayers {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
}

.squad-player {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 80px;
}

.squad-player-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 1px solid #000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
}

.squad-player-rating {
    font-size: 20px;
    font-weight: 600;
    color: white;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.squad-player-nickname {
    font-size: 10px;
    font-weight: 500;
    color: white;
    text-align: center;
    margin-top: 5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
}

/* Стили для цветов рейтинга (аналогичные основным игрокам) */
.squad-player-circle.bronze { background: linear-gradient(135deg, #cd7f32 0%, #a97142 100%); }
.squad-player-circle.silver { background: linear-gradient(135deg, #c0c0c0 0%, #909090 100%); }
.squad-player-circle.gold { background: linear-gradient(135deg, #ffd700 0%, #daa520 100%); }
.squad-player-circle.red { background: linear-gradient(135deg, #ff0000 0%, #8b0000 100%); }

.scorers-display {
    position: fixed;
    top: 40px; /* Располагаем под year-display */
    right: 10px;
    font-size: 12px;
    color: white;
    background: rgba(0, 0, 0, 0.7);
    padding: 8px 12px;
    border-radius: 8px;
    z-index: 2001;
    pointer-events: none;
    max-width: 200px;
    max-height: 200px;
    overflow-y: auto;
}

.scorers-display::-webkit-scrollbar {
    width: 4px;
}

.scorers-display::-webkit-scrollbar-thumb {
    background-color: #00bfff;
    border-radius: 2px;
}
</style>
</head>
<body>
<h2>Выберите состав команды</h2>

<div class="position-container" id="gk-container">
  <h3>Вратарь (GK)</h3>
  <div class="players-row"></div>
</div>

<div class="position-container" id="cdm-container">
  <h3>Опорный полузащитник (DM)</h3>
  <div class="players-row"></div>
</div>

<div class="position-container" id="st-container">
  <h3>Нападающий (ST)</h3>
  <div class="players-row"></div>
</div>

<div class="position-container" id="cf-container">
  <h3>Нападающий (ST)</h3>
  <div class="players-row"></div>
</div>

<button id="startButton" onclick="showTeamNameModal()">Начать турнир</button>

<!-- Модальное окно для ввода названия команды -->
<div id="teamNameModal">
  <div id="teamNamePopup">
    <h3>Введите название вашей команды</h3>
    <input type="text" id="teamNameInput" placeholder="Название команды" maxlength="20">
    <button id="confirmTeamName" onclick="confirmTeamName()">Подтвердить</button>
  </div>
</div>

<div id="matchOverlay">
  <div id="matchPopup">
   <div class="year-display" id="yearDisplay">Сезон 1</div>
   <div id="topScorersDisplay" class="scorers-display"></div>
    <div id="teamSquadPanel">
      <h3>Состав команды</h3>
      <div id="teamSquadPlayers"></div>
    </div>
    <div id="roundTitle"></div>
    <div class="game-style-buttons">
      <button class="style-button defensive" onclick="setGameStyle('defensive')">Оборонительный</button>
      <button class="style-button balanced selected" onclick="setGameStyle('balanced')">Баланс</button>
      <button class="style-button offensive" onclick="setGameStyle('offensive')">Атакующий</button>
    </div>
    <div class="vs-container">
      <div style="display: flex; flex-direction: column; align-items: center;">
        <div class="player-circle" style="margin-bottom: 25px;" id="teamRatingCircle">
          <div class="player-rating" id="userRatingDisplay"></div>
          <div class="player-nickname">Ваша команда</div>
        </div>
        <div class="team-name-display" id="userTeamName"></div>
      </div>
      <span style="margin: 0 25px; font-size: 28px;">VS</span>
      <div style="display: flex; flex-direction: column; align-items: center;">
        <img id="opponentLogo" alt="Opponent" class="team-logo">
        <div class="team-name-display" id="opponentName"></div>
      </div>
    </div>
    <div id="matchTime" class="match-time">0:00</div>
    <div id="scoreDisplay" class="score">0 : 0</div>
    <div id="eventsContainer" style="min-height: 60px;"></div>
    <p id="matchResult" style="margin: 25px 0; font-size: 20px;"></p>
    <button id="playButton" onclick="playMatch()" style="padding: 12px 25px; font-size: 18px; background-color: #2196F3; color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s;">Играть матч</button>
    <button id="backToMenuButton" onclick="backToMenu()">Вернуться в меню</button>
  </div>
</div>

<div id="statsOverlay">
  <div id="statsPopup">
    <div class="stats-title">Статистика турнира</div>
    <table class="stats-table" id="statsTable">
      <thead>
        <tr>
          <th>Игрок</th>
          <th>Голы</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="goldenBallContainer"></div>
    <button id="closeStatsButton" onclick="closeStats()" style="padding: 12px 25px; font-size: 18px; background-color: #2196F3; color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; margin-top: 20px; display: block; margin-left: auto; margin-right: auto;">Закрыть</button>
    <button id="newSeasonButton" onclick="startNewSeason()" style="padding: 12px 25px; font-size: 18px; background: linear-gradient(135deg, #4CAF50, #2E8B57); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; margin-top: 20px; display: none; margin-left: auto; margin-right: auto;">Следующий сезон</button>
  </div>
</div>

<div id="transferOverlay">
    <div id="transferPopup">
        <div class="transfer-title">Предложение на трансфер</div>
        <div class="transfer-players">
            <div class="transfer-player">
                <div class="transfer-player-title">Ваш текущий игрок</div>
                <div id="currentPlayer" class="player-circle gold">
                    <div class="player-rating">75</div>
                    <div class="player-nickname">Игрок</div>
                </div>
            </div>
            <div class="transfer-player">
                <div class="transfer-player-title">Предлагаемый игрок</div>
                <div id="offeredPlayer" class="player-circle gold">
                    <div class="player-rating">80</div>
                    <div class="player-nickname">Игрок</div>
                </div>
            </div>
        </div>
        <div class="transfer-buttons">
            <button class="transfer-button" onclick="acceptTransfer()">Обменять</button>
            <button class="transfer-button reject" onclick="rejectTransfer()">Отказать</button>
        </div>
    </div>
</div>

<!-- Модальное окно тренировки игрока -->
<div id="trainingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 2500; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
  <div id="trainingPopup" style="background: linear-gradient(145deg, #222, #1a1a1a); padding: 30px; border-radius: 15px; width: 95%; max-width: 500px; box-shadow: 0 0 20px rgba(0,0,0,0.6), 0 0 8px rgba(0, 191, 255, 0.15); border: 1px solid rgba(0, 191, 255, 0.1);">
    <h3 style="text-align: center; margin-bottom: 20px; color: #00bfff;">Кого отправить тренироваться? (+5 Рейтинг)</h3>
    <div id="trainingPlayers" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin: 20px 0;"></div>
    <button id="confirmTraining" onclick="confirmTraining()" style="padding: 12px 25px; font-size: 16px; font-weight: 600; background: linear-gradient(135deg, #0066cc, #00bfff); color: white; border: none; border-radius: 25px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: block; margin: 0 auto;">Подтвердить</button>
  </div>
</div>

<div id="newSeasonOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 3500; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
  <div style="background: linear-gradient(145deg, #222, #1a1a1a); padding: 30px; border-radius: 15px; width: 95%; max-width: 500px; box-shadow: 0 0 20px rgba(0,0,0,0.6), 0 0 8px rgba(0, 191, 255, 0.15); border: 1px solid rgba(0, 191, 255, 0.1);">
    <h3 style="text-align: center; margin-bottom: 20px; color: #00bfff;">Ваши игроки улучшились (+2 Рейтинг каждому)</h3>
    <div id="improvedPlayers" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin: 20px 0;"></div>
    <button onclick="continueAfterSeason()" style="padding: 12px 25px; font-size: 16px; font-weight: 600; background: linear-gradient(135deg, #0066cc, #00bfff); color: white; border: none; border-radius: 25px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: block; margin: 0 auto;">Продолжить</button>
  </div>
</div>

<script>
  // Защита от открытия консоли
  document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
  });
  
  document.addEventListener('keydown', function(e) {
    // Блокировка F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+Shift+C, Ctrl+U
    if (e.key === 'F12' || 
        (e.ctrlKey && e.shiftKey && e.key === 'I') || 
        (e.ctrlKey && e.shiftKey && e.key === 'J') ||
        (e.ctrlKey && e.shiftKey && e.key === 'C') ||
        (e.ctrlKey && e.key === 'U')) {
      e.preventDefault();
    }
  });
  


  const positions = {
    GK: { 
        container: document.getElementById('gk-container').querySelector('.players-row'), 
        selected: null, 
        players: [
            { rating: 95, nickname: "Nsk" },
            { rating: 91, nickname: "-nK" },
            { rating: 88, nickname: "Савитар" },
            { rating: 83, nickname: "ya tyanochka" },
            { rating: 84, nickname: "Fade Away" },
            { rating: 76, nickname: "diseased" },
            { rating: 82, nickname: "drak" },
            { rating: 65, nickname: "Nick" },
            { rating: 59, nickname: "natsukasiy" },
            { rating: 75, nickname: "Björn" },
            { rating: 59, nickname: "pluto" },
            { rating: 46, nickname: "Nagiev" },
            { rating: 53, nickname: "oskasya" },
            { rating: 55, nickname: "Sunex" },
            { rating: 60, nickname: "lis" },
            { rating: 88, nickname: "рагуль" },
            { rating: 64, nickname: "LS" },
            { rating: 65, nickname: "пиушка" },
            { rating: 41, nickname: "NO_ON" },
            { rating: 43, nickname: "Sky tempi" },
            { rating: 54, nickname: "Мама Вонти" },
            { rating: 56, nickname: "UCHIHAS" },
            { rating: 42, nickname: "denji-" },
            { rating: 54, nickname: "yowai" },
            { rating: 76, nickname: "Yoze" },
            { rating: 56, nickname: "servi" },
            { rating: 54, nickname: "Василий_Шатуновский." },
            { rating: 64, nickname: "Yedlin" },
            { rating: 89, nickname: "Madcon" },
            { rating: 82, nickname: "cotty" },
            { rating: 75, nickname: "Marco Reus" },
            { rating: 59, nickname: "zxz" },
            { rating: 45, nickname: "Трип" },
            { rating: 91, nickname: "Maddude" },
            { rating: 41, nickname: "Shaky" },
            { rating: 50, nickname: "Клаудиньо" },
            { rating: 48, nickname: "Yorho" },
            { rating: 50, nickname: "Avis" },
        ]
    },
    CDM: { 
        container: document.getElementById('cdm-container').querySelector('.players-row'), 
        selected: null, 
        players: [
            { rating: 93, nickname: "Wenamka" },
            { rating: 95, nickname: "Twistik" },
            { rating: 91, nickname: "Murphy" },
            { rating: 85, nickname: "koopinoff" },
            { rating: 89, nickname: "yokk" },
            { rating: 80, nickname: "шиммер" },
            { rating: 76, nickname: "zark-" },
            { rating: 65, nickname: "ottop" },
            { rating: 70, nickname: "wool" },
            { rating: 64, nickname: "Big boo" },
            { rating: 53, nickname: "friend shiro" },
            { rating: 52, nickname: "yeapez" },
            { rating: 57, nickname: "DENRELAS" },
            { rating: 55, nickname: "zxc" },
            { rating: 57, nickname: "13setz" },
            { rating: 90, nickname: "aero" },
            { rating: 80, nickname: "IIIHA" },
            { rating: 79, nickname: "boda" },
            { rating: 61, nickname: "pure" },  
            { rating: 54, nickname: "Scqxd" },
            { rating: 85, nickname: "adriano" }, 
            { rating: 90, nickname: "Solence" }, 
            { rating: 72, nickname: "Impo" }, 
            { rating: 52, nickname: "Jakov" }, 
            { rating: 63, nickname: "MaSsik" }, 
            { rating: 51, nickname: "чпек" }, 
            { rating: 57, nickname: "Candy" }, 
            { rating: 79, nickname: "Emkay" }, 
            { rating: 78, nickname: "Noshka" },
            { rating: 68, nickname: "jesslach" },
            { rating: 50, nickname: "fiograf " },
            { rating: 88, nickname: "Bachira" },
            { rating: 90, nickname: "modric8" },
            { rating: 94, nickname: "Anddy" },
            { rating: 89, nickname: "ıIıIİıİIımusic" },
            { rating: 85, nickname: "soul" },
            { rating: 52, nickname: "Shtrembl" },
            { rating: 45, nickname: "ʀʜᴇɪɴᴍᴇᴛᴀʟ" },
      ]
    },
    ST: { 
        container: document.getElementById('st-container').querySelector('.players-row'), 
        selected: null, 
        players: [
            { rating: 95, nickname: "Kor" },
            { rating: 91, nickname: "Filp" },
            { rating: 89, nickname: "lopo" },
            { rating: 81, nickname: "Tokito" },
            { rating: 87, nickname: "златан" },
            { rating: 77, nickname: "SUS" },
            { rating: 79, nickname: "Kiw" },
            { rating: 79, nickname: "Cyanide" },
            { rating: 74, nickname: "Разберусь" },
            { rating: 74, nickname: "Lean" },
            { rating: 58, nickname: "Jora young" },
            { rating: 53, nickname: "godmoves" },
            { rating: 49, nickname: "Verty" },
            { rating: 50, nickname: "fart" },
            { rating: 53, nickname: "тихий парень" },
            { rating: 89, nickname: "elox." },
            { rating: 69, nickname: "Жмых" },
            { rating: 63, nickname: "zvezzda" },
            { rating: 58, nickname: "dark_pr1nce" },
            { rating: 49, nickname: "rydii" },
            { rating: 69, nickname: "Timoxa196" },
            { rating: 81, nickname: "leT1m" },
            { rating: 60, nickname: "deko" },
            { rating: 49, nickname: "Nagi" },
            { rating: 67, nickname: "Волька" },
            { rating: 59, nickname: "буся" },
            { rating: 66, nickname: "iRaJ-" },
            { rating: 90, nickname: "Oven" },
            { rating: 84, nickname: "gunyasha" },
            { rating: 43, nickname: "гамик" },
            { rating: 77, nickname: "R3venGe-" },
            { rating: 46, nickname: "BeNzEmA" },
            { rating: 95, nickname: "KING" },
            { rating: 40, nickname: "Sivohin" },
            { rating: 40, nickname: "MR. LUKA" },
            { rating: 40, nickname: "plxdy" },
            { rating: 42, nickname: "yupix" },

        ]
    },
    CF: { 
        container: document.getElementById('cf-container').querySelector('.players-row'), 
        selected: null, 
        players: [
            { rating: 92, nickname: "ninowka" },
            { rating: 90, nickname: "step-" },
            { rating: 95, nickname: "Pyro" },
            { rating: 88, nickname: "iks" },
            { rating: 83, nickname: "parma2013" },
            { rating: 80, nickname: "Philip Brooks" },
            { rating: 78, nickname: "sproty" },
            { rating: 73, nickname: "berserk" },
            { rating: 73, nickname: "iwd" },
            { rating: 67, nickname: "Wilian31" },
            { rating: 53, nickname: "Malasi" },
            { rating: 54, nickname: "chesdes" },
            { rating: 40, nickname: "ЯРЫЙ" },
            { rating: 50, nickname: "Илуа" },
            { rating: 40, nickname: "PenguinN10" },
            { rating: 85, nickname: "Shepard" },
            { rating: 60, nickname: "Guus" },
            { rating: 60, nickname: "drakula" },
            { rating: 54, nickname: "zaraki" },
            { rating: 47, nickname: "holodok" },
            { rating: 52, nickname: "Chex" },
            { rating: 60, nickname: "butterfly" },
            { rating: 76, nickname: "Eazw" },
            { rating: 50, nickname: "flourgame" },
            { rating: 67, nickname: "Yapo" },
            { rating: 49, nickname: "Данис" },
            { rating: 95, nickname: "aMp" },
            { rating: 90, nickname: "Avr" },
            { rating: 91, nickname: "Х@тико" },
            { rating: 77, nickname: "Rasputin" },
            { rating: 45, nickname: "nevzyy" },
            { rating: 45, nickname: "convulsive_seizures" },
            { rating: 95, nickname: "Kl" },
            { rating: 65, nickname: "mY_ruleZ" },
            { rating: 92, nickname: "Levaldo" },
            { rating: 50, nickname: "GRENKA" },
            { rating: 44, nickname: "Faya (ы)" },
        ]
    }
};

  const numPlayersToShow = 5;
  const startButton = document.getElementById('startButton');

  const opponentTeams = [
    { name: "GreenLand", logo: "logo_GreenLand.png", rating: 67 },
    { name: "KUMYS POWER", logo: "logo_KUMYS POWER.png", rating: 64 },
    { name: "One more pass", logo: "logo_One more pass.png", rating: 64 },
    { name: "IDM", logo: "logo_IDM.png", rating: 60 },
    { name: "SHULC RS", logo: "logo_SHULC RS.png", rating: 55 },
    { name: "FC United", logo: "logo_FC United.png", rating: 63 },
    { name: "Karasuno", logo: "logo_Karasuno.png", rating: 58 },
    { name: "The Last Dance", logo: "logo_The Last Dance.png", rating: 47 },
    { name: "ХК Чертаново 2012", logo: "logo_ХК Чертаново 2012.png", rating: 50 },
    { name: "Anubis", logo: "logo_Anubis.png", rating: 45 },
    { name: "Bloodstream", logo: "logo_Bloodstream.png", rating: 57 },
    { name: "Anji", logo: "logo_Anji.png", rating: 55 },
    { name: "Оксидиум", logo: "logo_Оксидиум.png", rating: 50 },
    { name: "Дети Солнца", logo: "logo_Дети Солнца.png", rating: 47 },
    { name: "Хомяки", logo: "logo_Хомяки.png", rating: 45 },
    { name: "Bolich", logo: "logo_Bolich.png", rating: 43 },
    { name: "NoStuff", logo: "logo_NoStuff.png", rating: 44 },
    { name: "Monkey Business", logo: "logo_Monkey Business.png", rating: 51 },
    { name: "Everton", logo: "logo_Everton.png", rating: 40 },
    { name: "Злые бобры", logo: "logo_Злые бобры.png", rating: 38 },
    { name: "Water Heroes", logo: "logo_Water Heroes.png", rating: 40 },
    { name: "Печенеги", logo: "logo_Печенеги.png", rating: 41 },
    { name: "Братеки", logo: "logo_Братеки.png", rating: 34 },
    { name: "HC Platina", logo: "logo_HC Platina.png", rating: 33 },
    { name: "смеШАРики", logo: "logo_смеШАРики.png", rating: 31 },
    { name: "FC Miami Mamoball", logo: "logo_FC Miami Mamoball.png", rating: 25 },
    { name: "TikTok House", logo: "logo_TikTok House.png", rating: 22 },
    { name: "Moon Lovers", logo: "logo_Moon Lovers.png", rating: 27 },
    { name: "Поколение Чудес", logo: "logo_Поколение Чудес.png", rating: 20 },
    { name: "edelweiss", logo: "logo_edelweiss.png", rating: 20 },
    { name: "AS Tatarstan", logo: "logo_AS Tatarstan.png", rating: 65 },
    { name: "Medvjedi", logo: "logo_Medvjedi.png", rating: 64 },
    { name: "SkyRed", logo: "logo_SkyRed.png", rating: 33 },
    { name: "Вечерние звезды", logo: "logo_Вечерние звезды.png", rating: 50 },
    { name: "Bounty", logo: "logo_Bounty.png", rating: 40 },
    { name: "The Beatles", logo: "logo_The Beatles.png", rating: 38 },
    { name: "FC6", logo: "logo_FC6.png", rating: 18 },
    { name: "Томь", logo: "logo_Томь.png", rating: 19 },
    { name: "Yokohama City", logo: "logo_Yokohama City.png", rating: 40 },
    { name: "Metallurg", logo: "logo_Metallurg.png", rating: 44 },
    { name: "Smurfiki", logo: "logo_Smurfiki.png", rating: 64 },
    { name: "Grusteam", logo: "logo_Grusteam.png", rating: 63 },
    { name: "So EZ", logo: "logo_So EZ.png", rating: 52 },
    { name: "The Evil Agents", logo: "logo_The Evil Agents.png", rating: 50 },
    { name: "Freak Circus", logo: "logo_Freak Circus.png", rating: 50 },
    { name: "Manchester United", logo: "logo_Manchester United.png", rating: 40 },
    { name: "Wings Bird", logo: "logo_Wings Bird.png", rating: 40 },
    { name: "Interment", logo: "logo_Interment.png", rating: 20 },
    { name: "Internet Heroes", logo: "logo_Internet Heroes.png", rating: 30 },
    { name: "TMNT", logo: "logo_TMNT.png", rating: 40 },

    { name: "FEAR", logo: "logo_FEAR.png", rating: 65 },
    { name: "Flyin' Škrtels", logo: "logo_Fly.png", rating: 65 },
    { name: "Ghouls", logo: "logo_Ghouls.png", rating: 45 },
    { name: "Legendary Stars", logo: "logo_Legendary Stars.png", rating: 50 },
    { name: "Pornhub", logo: "logo_Pornhub.png", rating: 50 },
    { name: "HaxMill City", logo: "logo_HaxMill City.png", rating: 20 },
    { name: "Need Music", logo: "logo_Need Music.png", rating: 20 },
    { name: "HC Glass", logo: "logo_HC Glass.png", rating: 40 },
    { name: "Karabah", logo: "logo_Karabah.png", rating: 20 },
    { name: "Шайка-04", logo: "logo_Шайка-04.png", rating: 37 },

];

let currentRound = 32;
let currentYear = 1;
let userTeamRating = 0;
let currentOpponent = null;
let matchInterval = null;
let currentTime = 0;
let userGoals = 0;
let opponentGoals = 0;
let goalEvents = [];
let userTeamName = "Ваша команда";
let usedOpponents = [];
let scorers = {}; // Object to track player goals
let allTimeScorers = {}; // Для хранения всей статистики
let seasonScorers = {};  // Для хранения статистики текущего сезона
let tournamentWon = false;
let gameStyle = 'balanced'; // По умолчанию баланс
let isInLowerBracket = false; // Находится ли игрок в нижней сетке
let lowerBracketRound = 0; // Текущий раунд в нижней сетке

// Функция для установки стиля игры
function setGameStyle(style) {
    gameStyle = style;
    // Обновляем визуальное выделение кнопок
    document.querySelectorAll('.style-button').forEach(btn => {
        btn.classList.remove('selected');
    });
    document.querySelector(`.style-button.${style}`).classList.add('selected');
}

// Функция для показа модального окна с вводом названия команды
function showTeamNameModal() {
    if (!checkAllSelected()) {
        alert("Пожалуйста, выберите игроков на всех позициях!");
        return;
    }
    document.getElementById('teamNameModal').style.display = 'flex';
}

// Функция для подтверждения названия команды
function confirmTeamName() {
    const nameInput = document.getElementById('teamNameInput');
    if (nameInput.value.trim() === '') {
        alert("Пожалуйста, введите название команды!");
        return;
    }
    userTeamName = nameInput.value.trim();
    document.getElementById('teamNameModal').style.display = 'none';
    startTournament();
}

function backToMenu() {
    window.location.href = "https://jorayoung.github.io/DraftMenu/";
}

function getRandomScorer(position) {
    if (position === "GK") {
        // Шанс 1%, что вратарь забьет гол
        if (Math.random() < 0.01) {
            return positions[position].selected.nickname;
        }
        return null;
    }
    
    const players = positions[position].players;
    const activePlayers = players.filter(p => positions[position].selected && 
        positions[position].selected.nickname === p.nickname);
    
    if (activePlayers.length > 0) {
        return activePlayers[0].nickname;
    }
    
    const availablePlayers = positions[position].players;
    if (availablePlayers.length > 0) {
        return availablePlayers[Math.floor(Math.random() * availablePlayers.length)].nickname;
    }
    return "Игрок";
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function getNextOpponent() {
    const availableTeams = opponentTeams.filter(team => !usedOpponents.includes(team.name));
    
    if (availableTeams.length === 0) {
        usedOpponents = [];
        return opponentTeams[Math.floor(Math.random() * opponentTeams.length)];
    }
    
    availableTeams.sort((a, b) => b.rating - a.rating);
    
    const weights = availableTeams.map((team, index) => {
        const baseWeight = availableTeams.length - index;
        const randomFactor = Math.random() * 3;
        return baseWeight + randomFactor;
    });
    
    const sumWeights = weights.reduce((a, b) => a + b, 0);
    const normalizedWeights = weights.map(w => w / sumWeights);
    
    let random = Math.random();
    let weightSum = 0;
    for (let i = 0; i < availableTeams.length; i++) {
        weightSum += normalizedWeights[i];
        if (random <= weightSum) {
            return availableTeams[i];
        }
    }
    
    return availableTeams[0];
}

function showPlayers(position) {
    shuffleArray(positions[position].players);
    positions[position].container.innerHTML = '';

    for (let i = 0; i < numPlayersToShow; i++) {
        if (!positions[position].players[i]) continue;
        const playerData = positions[position].players[i];
        
        const playerWrapper = document.createElement('div');
        playerWrapper.className = 'player-wrapper';
        
        const playerCircle = document.createElement('div');
        playerCircle.className = 'player-circle';
        playerCircle.dataset.rating = playerData.rating;
        playerCircle.dataset.nickname = playerData.nickname;
        
        if (playerData.rating >= 40 && playerData.rating <= 60) {
            playerCircle.classList.add('bronze');
        } else if (playerData.rating >= 61 && playerData.rating <= 80) {
            playerCircle.classList.add('silver');
        } else if (playerData.rating >= 81 && playerData.rating <= 99) {
            playerCircle.classList.add('gold');
        } else if (playerData.rating >= 100 && playerData.rating <= 110) {
            playerCircle.classList.add('red');
        }
        
        const ratingDiv = document.createElement('div');
        ratingDiv.className = 'player-rating';
        ratingDiv.textContent = playerData.rating;
        
        const nicknameDiv = document.createElement('div');
        nicknameDiv.className = 'player-nickname';
        nicknameDiv.textContent = playerData.nickname;
        
        playerCircle.appendChild(ratingDiv);
        playerCircle.appendChild(nicknameDiv);
        playerWrapper.appendChild(playerCircle);
        
        playerCircle.addEventListener('click', () => {
            const allPlayers = positions[position].container.querySelectorAll('.player-circle');
            allPlayers.forEach(p => p.classList.remove('selected'));
            
            playerCircle.classList.add('selected');
            positions[position].selected = playerData;
            
            if (checkAllSelected()) {
                startButton.style.display = 'block';
            } else {
                startButton.style.display = 'none';
            }
        });
        
        positions[position].container.appendChild(playerWrapper);
    }
}

function checkAllSelected() {
    for (const position in positions) {
        if (!positions[position].selected) {
            return false;
        }
    }
    return true;
}

function calculateUserTeamRating() {
    let totalRating = 0;
    let count = 0;
    for (const position in positions) {
        if (positions[position].selected) {
            totalRating += positions[position].selected.rating;
            count++;
        }
    }
    return Math.round(totalRating / count);
}

function generateGoalEvents(userRating, opponentRating) {
    const events = [];
    const matchDuration = 16;
    const ratingDifference = userRating - opponentRating;
    
    // Модификаторы в зависимости от стиля игры
    let userGoalModifier = 1;
    let opponentGoalModifier = 1;
    
    if (gameStyle === 'defensive') {
        userGoalModifier = 0.5;
        opponentGoalModifier = 0.5;
    } else if (gameStyle === 'offensive') {
        userGoalModifier = 2;
        opponentGoalModifier = 2;
    }
    
    const userGoalProbability = (0.4 + (0.5 * ratingDifference / 100) + (Math.random() * 0.17 - 0.085)) * userGoalModifier;
    const opponentGoalProbability = (0.4 - (0.3 * ratingDifference / 100) + (Math.random() * 0.17 - 0.085)) * opponentGoalModifier;
    
    const totalGoals = Math.max(1, Math.min(10, Math.round((3 + (userRating + opponentRating)/40 + (Math.random() * 3.4 - 1.7)) * (gameStyle === 'defensive' ? 0.5 : gameStyle === 'offensive' ? 2 : 1))));
    
    const goalTimes = [];
    for (let i = 0; i < totalGoals; i++) {
        goalTimes.push(Math.floor(Math.random() * matchDuration));
    }
    goalTimes.sort((a, b) => a - b);
    
    for (const time of goalTimes) {
        const isUserGoal = Math.random() < userGoalProbability / (userGoalProbability + opponentGoalProbability);
        let scorer = "";
        
        if (isUserGoal) {
            // Шанс 1%, что гол забьет вратарь
            if (Math.random() < 0.01 && positions.GK.selected) {
                scorer = positions.GK.selected.nickname;
            } else {
                const scoringPositions = ["CDM", "ST", "CF"];
                const randomPosition = scoringPositions[Math.floor(Math.random() * scoringPositions.length)];
                scorer = getRandomScorer(randomPosition);
            }
        } else {
            scorer = "Игрок";
        }
        
        events.push({
            time: time,
            isUserGoal: isUserGoal,
            scorer: scorer
        });
    }
    
    return events;
}
function showTournamentStats() {
    const statsTable = document.querySelector('#statsTable tbody');
    statsTable.innerHTML = '';
    
    // Convert scorers object to array and sort by goals
const scorersArray = Object.keys(seasonScorers).map(name => ({
    name: name,
    goals: seasonScorers[name]
})).sort((a, b) => b.goals - a.goals);
    
    // Display top scorers
    scorersArray.forEach((scorer, index) => {
        const row = document.createElement('tr');
        
        const nameCell = document.createElement('td');
        nameCell.textContent = scorer.name;
        row.appendChild(nameCell);
        
        const goalsCell = document.createElement('td');
        goalsCell.textContent = scorer.goals;
        row.appendChild(goalsCell);
        
        statsTable.appendChild(row);
    });
    
    // Show golden ball if tournament was won
    const goldenBallContainer = document.getElementById('goldenBallContainer');
    goldenBallContainer.innerHTML = '';
    
    if (tournamentWon && scorersArray.length > 0) {
        const topScorer = scorersArray[0];
        const goldenBallDiv = document.createElement('div');
        goldenBallDiv.className = 'golden-ball';
        goldenBallDiv.innerHTML = `
            <div class="golden-ball-icon">🏆</div>
            <div>Золотой мяч турнира вручается ${topScorer.name} (${topScorer.goals} голов)</div>
        `;
        goldenBallContainer.appendChild(goldenBallDiv);
    }
    
    document.getElementById('statsOverlay').style.display = 'flex';
}

function closeStats() {
    document.getElementById('statsOverlay').style.display = 'none';
}

function simulateMatch() {
    // Скрываем кнопки при старте матча
    document.getElementById('playButton').style.display = 'none';
    document.getElementById('backToMenuButton').style.display = 'none';
    
    clearInterval(matchInterval);
    document.getElementById('playButton').style.display = 'none';
    document.getElementById('scoreDisplay').textContent = '0 : 0';
    document.getElementById('eventsContainer').innerHTML = '';
    
    currentTime = 0;
    userGoals = 0;
    opponentGoals = 0;
    goalEvents = generateGoalEvents(userTeamRating, currentOpponent.rating);
    
    matchInterval = setInterval(() => {
        currentTime += 0.5;
        const minutes = Math.floor(currentTime);
        const seconds = currentTime % 1 === 0 ? '00' : '30';
        
        document.getElementById('matchTime').textContent = `${minutes}:${seconds}`;
        
        const currentEvents = goalEvents.filter(e => Math.floor(e.time) === minutes);
        for (const event of currentEvents) {
            if (event.isUserGoal) {
                userGoals++;
                const goalEvent = document.createElement('div');
                goalEvent.className = 'goal-event user-goal';
                goalEvent.textContent = `${minutes}:${seconds} ⚽ ГОЛ! ${event.scorer} забивает за вашу команду!`;
                document.getElementById('eventsContainer').prepend(goalEvent);
                
                // Update scorers statistics only when goal is actually scored
                if (event.scorer) {
    // Обновляем статистику сезона
    if (!seasonScorers[event.scorer]) {
        seasonScorers[event.scorer] = 0;
    }
    seasonScorers[event.scorer]++;
    
    // Обновляем общую статистику
    if (!allTimeScorers[event.scorer]) {
        allTimeScorers[event.scorer] = 0;
    }
    allTimeScorers[event.scorer]++;
    
    updateTopScorersDisplay();
}
            } else {
                opponentGoals++;
                const goalEvent = document.createElement('div');
                goalEvent.className = 'goal-event opponent-goal';
                goalEvent.textContent = `${minutes}:${seconds} ⚽ ГОЛ! ${event.scorer} забивает за ${currentOpponent.name}!`;
                document.getElementById('eventsContainer').prepend(goalEvent);
            }
            document.getElementById('scoreDisplay').textContent = `${userGoals} : ${opponentGoals}`;
        }
        
        if (currentTime >= 16) {
            clearInterval(matchInterval);
            finishMatch();
        }
    }, 531.25);
}

function finishMatch() {
    // Скрываем кнопки перед дополнительным временем
    document.getElementById('playButton').style.display = 'none';
    document.getElementById('backToMenuButton').style.display = 'none';

    // Проверяем, закончился ли матч вничью
    if (userGoals === opponentGoals) {
        // Добавляем сообщение о дополнительном времени
        const extraTimeMsg = document.createElement('div');
        extraTimeMsg.className = 'goal-event';
        extraTimeMsg.textContent = `Матч закончился вничью! Добавляется 8 минут дополнительного времени...`;
        document.getElementById('eventsContainer').prepend(extraTimeMsg);
        
        // Запускаем дополнительное время через 2 секунды
        setTimeout(() => {
            playExtraTime(8); // 8 минут дополнительного времени
        }, 2000);
        return;
    }
    
    // Если не ничья, продолжаем обычную логику
    determineMatchOutcome();
}

function playExtraTime(duration) {
    // Скрываем кнопки в начале дополнительного времени
    document.getElementById('playButton').style.display = 'none';
    document.getElementById('backToMenuButton').style.display = 'none';

    // Генерируем события для дополнительного времени
    const extraTimeEvents = generateExtraTimeEvents(userTeamRating, currentOpponent.rating, duration);
    let extraTimeGoals = 0;
    
    // Добавляем сообщение о начале дополнительного времени
    const startMsg = document.createElement('div');
    startMsg.className = 'goal-event';
    startMsg.textContent = `Началось дополнительное время (${duration} минут)`;
    document.getElementById('eventsContainer').prepend(startMsg);
    
    // Симулируем дополнительное время
    let extraTimePassed = 0;
    const extraTimeInterval = setInterval(() => {
        extraTimePassed += 0.5;
        const minutes = Math.floor(extraTimePassed);
        const seconds = extraTimePassed % 1 === 0 ? '00' : '30';
        
        // Проверяем события в текущую минуту
        const currentEvents = extraTimeEvents.filter(e => Math.floor(e.time) === minutes);
        for (const event of currentEvents) {
            if (event.isUserGoal) {
                userGoals++;
                extraTimeGoals++;
                const goalEvent = document.createElement('div');
                goalEvent.className = 'goal-event user-goal';
                goalEvent.textContent = `${event.time}' ⚽ ГОЛ! ${event.scorer} забивает за вашу команду в дополнительное время!`;
                document.getElementById('eventsContainer').prepend(goalEvent);
                
                if (event.scorer) {
                    if (!scorers[event.scorer]) {
                        scorers[event.scorer] = 0;
                    }
                    scorers[event.scorer]++;
                    updateTopScorersDisplay();
                }
            } else {
                opponentGoals++;
                extraTimeGoals++;
                const goalEvent = document.createElement('div');
                goalEvent.className = 'goal-event opponent-goal';
                goalEvent.textContent = `${event.time}' ⚽ ГОЛ! ${event.scorer} забивает за ${currentOpponent.name} в дополнительное время!`;
                document.getElementById('eventsContainer').prepend(goalEvent);
            }
            document.getElementById('scoreDisplay').textContent = `${userGoals} : ${opponentGoals}`;
        }
        
        // Обновляем таймер
        document.getElementById('matchTime').textContent = `16+${minutes}:${seconds}`;
        
        // Проверяем окончание дополнительного времени
        if (extraTimePassed >= duration) {
            clearInterval(extraTimeInterval);
            
            // Добавляем сообщение о завершении дополнительного времени
            const endMsg = document.createElement('div');
            endMsg.className = 'goal-event';
            endMsg.textContent = `Дополнительное время завершено. Забито голов: ${extraTimeGoals}`;
            document.getElementById('eventsContainer').prepend(endMsg);
            
            // Проверяем, осталась ли ничья
            if (userGoals === opponentGoals) {
                // Если ничья, добавляем еще 8 минут
                setTimeout(() => {
                    const extraMsg = document.createElement('div');
                    extraMsg.className = 'goal-event';
                    extraMsg.textContent = `Матч все еще вничью! Добавляется еще 8 минут дополнительного времени...`;
                    document.getElementById('eventsContainer').prepend(extraMsg);
                    
                    setTimeout(() => {
                        playExtraTime(8); // Еще 8 минут
                    }, 2000);
                }, 2000);
            } else {
                // Если есть победитель, определяем исход
                setTimeout(determineMatchOutcome, 2000);
            }
        }
    }, 1000); // Увеличиваем интервал для лучшей видимости
}

function determineMatchOutcome() {
    // Показываем кнопки после завершения матча
    document.getElementById('playButton').style.display = 'block';
    document.getElementById('backToMenuButton').style.display = 'block';

    if (userGoals > opponentGoals) {
        // Логика победы
        document.getElementById('matchResult').textContent = "Вы победили!";
        
        if (isInLowerBracket) {
            // Победа в нижней сетке
            lowerBracketRound /= 2;
            
            if (lowerBracketRound === 1) {
                // Финал нижней сетки - переход в основной финал
                isInLowerBracket = false;
                currentRound = 1;
                document.getElementById('matchResult').textContent = "Вы победили в нижней сетке и вышли в финал!";
                setTimeout(nextMatch, 2000);
            } else if (lowerBracketRound >= 1) {
                // Обычный раунд нижней сетки
                if (lowerBracketRound === 32) {
                    showTransferOffer();
                } else if (lowerBracketRound === 128 || lowerBracketRound === 8 || lowerBracketRound === 2) {
                    setTimeout(showTrainingMenu, 1);
                } else {
                    setTimeout(nextMatch, 2000);
                }
                return;
            }
        } else {
            // Победа в основной сетке
            currentRound /= 2;
        }
        
        // Общая логика после победы
        if (currentRound >= 1) {
            if (currentRound === 32 && !isInLowerBracket) {
                showTransferOffer();
            } else if (currentRound === 128 || currentRound === 8 || currentRound === 2) {
                setTimeout(showTrainingMenu, 1);
            } else {
                setTimeout(nextMatch, 2000);
            }
        } else {
            tournamentWon = true;
            document.getElementById('matchResult').textContent = "🏆 Поздравляем! Вы выиграли турнир! 🏆";
            document.getElementById("playButton").style.display = "none";
            document.getElementById("newSeasonButton").style.display = "block";
            setTimeout(showTournamentStats, 1000);
        }
    } else {
        // Логика поражения
        if (currentRound === 1 || (isInLowerBracket && lowerBracketRound === 1)) {
            document.getElementById('matchResult').textContent = "Вы проиграли! Турнир окончен.";
            document.getElementById("playButton").style.display = "none";
            setTimeout(showTournamentStats, 1000);
        } else if (!isInLowerBracket) {
            isInLowerBracket = true;
            lowerBracketRound = currentRound * 2;
            document.getElementById('matchResult').textContent = "Вы проиграли и переходите в нижнюю сетку!";
            
            if (lowerBracketRound === 32) {
                showTransferOffer();
            } else {
                setTimeout(nextMatch, 2000);
            }
        } else {
            document.getElementById('matchResult').textContent = "Вы проиграли в нижней сетке! Турнир окончен.";
            document.getElementById("playButton").style.display = "none";
            setTimeout(showTournamentStats, 1000);
        }
    }
}

// Новая функция для генерации событий в дополнительное время
function generateExtraTimeEvents(userRating, opponentRating, duration) {
    const events = [];
    const ratingDifference = userRating - opponentRating;
    
    // Модификаторы в зависимости от стиля игры
    let userGoalModifier = 1;
    let opponentGoalModifier = 1;
    
    if (gameStyle === 'defensive') {
        userGoalModifier = 0.5;
        opponentGoalModifier = 0.5;
    } else if (gameStyle === 'offensive') {
        userGoalModifier = 2;
        opponentGoalModifier = 2;
    }
    
    const userGoalProbability = (0.4 + (0.5 * ratingDifference / 100) + (Math.random() * 0.17 - 0.085)) * userGoalModifier;
    const opponentGoalProbability = (0.4 - (0.3 * ratingDifference / 100) + (Math.random() * 0.17 - 0.085)) * opponentGoalModifier;
    
    // В дополнительное время обычно забивают меньше голов
    const totalGoals = Math.max(0, Math.min(3, Math.round((1 + (userRating + opponentRating)/80 + (Math.random() * 1.7 - 0.85)) * (gameStyle === 'defensive' ? 0.5 : gameStyle === 'offensive' ? 2 : 1))));
    
    const goalTimes = [];
    for (let i = 0; i < totalGoals; i++) {
        goalTimes.push(Math.floor(Math.random() * duration));
    }
    goalTimes.sort((a, b) => a - b);
    
    for (const time of goalTimes) {
        const isUserGoal = Math.random() < userGoalProbability / (userGoalProbability + opponentGoalProbability);
        let scorer = "";
        
        if (isUserGoal) {
            // Шанс 1%, что гол забьет вратарь
            if (Math.random() < 0.01 && positions.GK.selected) {
                scorer = positions.GK.selected.nickname;
            } else {
                const scoringPositions = ["CDM", "ST", "CF"];
                const randomPosition = scoringPositions[Math.floor(Math.random() * scoringPositions.length)];
                scorer = getRandomScorer(randomPosition);
            }
        } else {
            scorer = "Игрок";
        }
        
        events.push({
            time: time,
            isUserGoal: isUserGoal,
            scorer: scorer
        });
    }
    
    return events;
}

function playMatch() {
    document.getElementById('backToMenuButton').style.display = 'none';
    simulateMatch();
}

function nextMatch() {
    currentOpponent = getNextOpponent();
    usedOpponents.push(currentOpponent.name);
    
    document.getElementById('opponentLogo').src = currentOpponent.logo;
    document.getElementById('opponentName').textContent = currentOpponent.name;
    
    const roundTitle = document.getElementById('roundTitle');
    if (isInLowerBracket) {
        if (lowerBracketRound === 1) {
            roundTitle.innerHTML = '<div class="final-banner">ФИНАЛ НИЖНЕЙ СЕТКИ</div>';
        } else {
            roundTitle.innerHTML = `<h3>1/${lowerBracketRound} финала (нижняя сетка)</h3>`;
        }
    } else {
        if (currentRound === 1) {
            roundTitle.innerHTML = '<div class="final-banner">ФИНАЛ</div>';
        } else {
            roundTitle.innerHTML = `<h3>1/${currentRound} финала</h3>`;
        }
    }
    
    document.getElementById('scoreDisplay').textContent = '0 : 0';
    document.getElementById('matchResult').textContent = '';
    document.getElementById('matchTime').textContent = '0:00';
    document.getElementById('eventsContainer').innerHTML = '';
    document.getElementById('backToMenuButton').style.display = 'none';
}

function startTournament() {
    // Reset statistics for new tournament
    seasonScorers = {}; // Сбрасываем только статистику сезона
    tournamentWon = false;
    isInLowerBracket = false;
    lowerBracketRound = 0;
    
    userTeamRating = calculateUserTeamRating();
    document.getElementById('userRatingDisplay').textContent = userTeamRating;
    updateTeamSquadDisplay();
    updateTeamRatingCircle();
    currentRound = 256;
    usedOpponents = [];
    document.getElementById("newSeasonButton").style.display = "none";
    document.getElementById('matchOverlay').style.display = 'flex';
    document.getElementById('matchResult').textContent = '';
    document.getElementById('playButton').style.display = 'block';
    document.getElementById('userRatingDisplay').textContent = userTeamRating;
    document.getElementById('userTeamName').textContent = userTeamName;
    document.getElementById('backToMenuButton').style.display = 'none';
    document.getElementById('yearDisplay').textContent = `Сезон ${currentYear}`;
    nextMatch();
}

window.onload = function() {
    for (const position in positions) {
        showPlayers(position);
    }
};

// Transfer Offer Functions
function showTransferOffer() {
    // Find the weakest player in the team
    let weakestPlayer = null;
    let weakestRating = 100;
    let weakestPosition = null;
    
    for (const position in positions) {
        if (positions[position].selected && positions[position].selected.rating < weakestRating) {
            weakestRating = positions[position].selected.rating;
            weakestPlayer = positions[position].selected;
            weakestPosition = position;
        }
    }
    
    if (!weakestPlayer || !weakestPosition) {
        nextMatch(); // Если не нашли слабого игрока, сразу продолжаем турнир
        return;
    }
    
    // Find a random player from the same position with higher rating
    const availablePlayers = positions[weakestPosition].players.filter(
        p => p.rating > weakestRating && p.nickname !== weakestPlayer.nickname
    );
    
    if (availablePlayers.length === 0) {
        nextMatch(); // Если нет подходящих игроков, сразу продолжаем турнир
        return;
    }
    
    const offeredPlayer = availablePlayers[Math.floor(Math.random() * availablePlayers.length)];
    
    // Update transfer modal UI
    const currentPlayerCircle = document.getElementById('currentPlayer');
    currentPlayerCircle.querySelector('.player-rating').textContent = weakestPlayer.rating;
    currentPlayerCircle.querySelector('.player-nickname').textContent = weakestPlayer.nickname;
    
    const offeredPlayerCircle = document.getElementById('offeredPlayer');
    offeredPlayerCircle.querySelector('.player-rating').textContent = offeredPlayer.rating;
    offeredPlayerCircle.querySelector('.player-nickname').textContent = offeredPlayer.nickname;
    
    // Set rating class
    [currentPlayerCircle, offeredPlayerCircle].forEach(circle => {
        circle.className = 'player-circle';
        const rating = parseInt(circle.querySelector('.player-rating').textContent);
        if (rating >= 40 && rating <= 60) {
            circle.classList.add('bronze');
        } else if (rating >= 61 && rating <= 80) {
            circle.classList.add('silver');
        } else if (rating >= 81 && rating <= 99) {
            circle.classList.add('gold');
        }
    });
    
    // Store transfer data
    currentPlayerCircle.dataset.position = weakestPosition;
    currentPlayerCircle.dataset.nickname = weakestPlayer.nickname;
    offeredPlayerCircle.dataset.position = weakestPosition;
    offeredPlayerCircle.dataset.nickname = offeredPlayer.nickname;
    offeredPlayerCircle.dataset.rating = offeredPlayer.rating;
    
    // Устанавливаем заголовок для обычного трансфера
    document.querySelector('.transfer-title').textContent = 'Предложение на трансфер';
    
    // Show transfer modal immediately
    document.getElementById('transferOverlay').style.display = 'flex';
}

function acceptTransfer() {
    const currentPlayerCircle = document.getElementById('currentPlayer');
    const offeredPlayerCircle = document.getElementById('offeredPlayer');
    
    const position = currentPlayerCircle.dataset.position;
    const oldNickname = currentPlayerCircle.dataset.nickname;
    const newNickname = offeredPlayerCircle.dataset.nickname;
    const newRating = parseInt(offeredPlayerCircle.dataset.rating);
    
    // Находим предлагаемого игрока
    const offeredPlayer = positions[position].players.find(p => p.nickname === newNickname);
    
    if (offeredPlayer) {
        // Удаляем статистику старого игрока
        // Переносим статистику при трансфере
if (allTimeScorers[oldNickname]) {
    allTimeScorers[newNickname] = (allTimeScorers[newNickname] || 0) + allTimeScorers[oldNickname];
    delete allTimeScorers[oldNickname];
}

if (seasonScorers[oldNickname]) {
    seasonScorers[newNickname] = (seasonScorers[newNickname] || 0) + seasonScorers[oldNickname];
    delete seasonScorers[oldNickname];
}
        
        // Начинаем статистику нового игрока с нуля
        scorers[newNickname] = 0;
        
        // Обновляем выбранного игрока
        positions[position].selected = offeredPlayer;
        
        // Обновляем рейтинг команды
        userTeamRating = calculateUserTeamRating();
        updateTeamSquadDisplay(); // Добавляем эту строку
        updateTopScorersDisplay();
        document.getElementById('userRatingDisplay').textContent = userTeamRating;
    }
    
    // Закрываем окно трансфера
    document.getElementById('transferOverlay').style.display = 'none';
    
    // Показываем следующее трансферное предложение или начинаем сезон
    if (showOffseasonTransfer.transferCount < 2) {
        showOffseasonTransfer();
    }
}

function rejectTransfer() {
    // Закрываем окно трансфера
    document.getElementById('transferOverlay').style.display = 'none';
    
    // Показываем следующее трансферное предложение или начинаем сезон
    if (showOffseasonTransfer.transferCount < 2) {
        showOffseasonTransfer();
    }
}

// Функция для показа меню тренировки
function showTrainingMenu() {
    const trainingPlayersContainer = document.getElementById('trainingPlayers');
    trainingPlayersContainer.innerHTML = '';
    
    // Создаем круги для каждого выбранного игрока
    for (const position in positions) {
        if (positions[position].selected) {
            const player = positions[position].selected;
            
            const playerCircle = document.createElement('div');
            playerCircle.className = 'player-circle';
            playerCircle.style.cursor = 'pointer';
            playerCircle.style.margin = '0';
            playerCircle.dataset.position = position;
            playerCircle.dataset.nickname = player.nickname;
            playerCircle.dataset.rating = player.rating;
            
            if (player.rating >= 40 && player.rating <= 60) {
                playerCircle.classList.add('bronze');
            } else if (player.rating >= 61 && player.rating <= 80) {
                playerCircle.classList.add('silver');
            } else if (player.rating >= 81 && player.rating <= 99) {
                playerCircle.classList.add('gold');
            } else if (player.rating >= 100 && player.rating <= 110) {
                playerCircle.classList.add('red');
            }
            
            const ratingDiv = document.createElement('div');
            ratingDiv.className = 'player-rating';
            ratingDiv.textContent = player.rating;
            
            const nicknameDiv = document.createElement('div');
            nicknameDiv.className = 'player-nickname';
            nicknameDiv.textContent = player.nickname;
            
            playerCircle.appendChild(ratingDiv);
            playerCircle.appendChild(nicknameDiv);
            
            playerCircle.addEventListener('click', function() {
                // Убираем выделение у всех игроков
                document.querySelectorAll('#trainingPlayers .player-circle').forEach(circle => {
                    circle.classList.remove('selected');
                });
                
                // Выделяем выбранного игрока
                this.classList.add('selected');
            });
            
            trainingPlayersContainer.appendChild(playerCircle);
        }
    }
    
    document.getElementById('trainingOverlay').style.display = 'flex';
}
// Функция для подтверждения тренировки
function confirmTraining() {
    const selectedPlayerCircle = document.querySelector('#trainingPlayers .player-circle.selected');
    
    if (!selectedPlayerCircle) {
        alert('Пожалуйста, выберите игрока для тренировки!');
        return;
    }
    
    const position = selectedPlayerCircle.dataset.position;
    const nickname = selectedPlayerCircle.dataset.nickname;
    const currentRating = parseInt(selectedPlayerCircle.dataset.rating);
    
    // Находим игрока в массиве и обновляем его рейтинг
    const playerIndex = positions[position].players.findIndex(p => p.nickname === nickname);
    if (playerIndex !== -1) {
        // Увеличиваем рейтинг, но не более 110
        const newRating = Math.min(currentRating + 5, 110);
        positions[position].players[playerIndex].rating = newRating;
        
        // Если это выбранный игрок, обновляем и его рейтинг
        if (positions[position].selected && positions[position].selected.nickname === nickname) {
            positions[position].selected.rating = newRating;
            userTeamRating = calculateUserTeamRating();
document.getElementById('userRatingDisplay').textContent = userTeamRating;
    updateTeamSquadDisplay(); // Добавляем эту строку
updateTeamRatingCircle(); // Добавить эту строку
        }
    }
    
    // Закрываем меню тренировки
    document.getElementById('trainingOverlay').style.display = 'none';
    
    // Продолжаем турнир
    nextMatch();
}

function startNewSeason() {
    currentYear++;
    document.getElementById('yearDisplay').textContent = `Сезон ${currentYear}`;

    // Сохраняем общую статистику и сбрасываем сезонную
    seasonScorers = {};
    // Сбросить турнирные данные
    currentRound = 256;
    usedOpponents = [];
    tournamentWon = false;
    isInLowerBracket = false;
    lowerBracketRound = 0;
    
    
    // Закрыть статистику
    document.getElementById('statsOverlay').style.display = 'none';
    
    // Обновить рейтинг команды
    userTeamRating = calculateUserTeamRating();
    document.getElementById('userRatingDisplay').textContent = userTeamRating;
    updateTeamRatingCircle(); // Добавить этот вызов
    
    // Сбросить состояние матча
    document.getElementById('matchOverlay').style.display = 'flex';
    document.getElementById('matchResult').textContent = '';
    document.getElementById('playButton').style.display = 'block';
    document.getElementById('backToMenuButton').style.display = 'none';
    document.getElementById('newSeasonButton').style.display = 'none';
    document.getElementById('scoreDisplay').textContent = '0 : 0';
    document.getElementById('eventsContainer').innerHTML = '';
    
    // Установить правильный раунд в интерфейсе
    const roundTitle = document.getElementById('roundTitle');
    roundTitle.innerHTML = `<h3>1/${currentRound} финала</h3>`;
    
    // Получить нового соперника
    currentOpponent = getNextOpponent();
    usedOpponents.push(currentOpponent.name);
    
    // Обновить интерфейс соперника
    document.getElementById('opponentLogo').src = currentOpponent.logo;
    document.getElementById('opponentName').textContent = currentOpponent.name;
    showPlayersImprovement();
}

function showPlayersImprovement() {
    const improvedPlayersContainer = document.getElementById('improvedPlayers');
    improvedPlayersContainer.innerHTML = '';
    
    // Улучшить всех выбранных игроков и обновить их рейтинг
    for (const position in positions) {
        if (positions[position].selected) {
            const player = positions[position].selected;
            
            // Найти игрока в массиве и обновить его рейтинг
            const playerIndex = positions[position].players.findIndex(p => p.nickname === player.nickname);
            if (playerIndex !== -1) {
                // Увеличиваем рейтинг, но не более 110
                const newRating = Math.min(player.rating + 2, 110);
                positions[position].players[playerIndex].rating = newRating;
                positions[position].selected.rating = newRating;
                
                // Создать элемент для отображения улучшенного игрока
                const playerCircle = document.createElement('div');
                playerCircle.className = 'player-circle';
                playerCircle.style.margin = '0';
                
                if (newRating >= 40 && newRating <= 60) {
                    playerCircle.classList.add('bronze');
                } else if (newRating >= 61 && newRating <= 80) {
                    playerCircle.classList.add('silver');
                } else if (newRating >= 81 && newRating <= 99) {
                    playerCircle.classList.add('gold');
                } else if (newRating >= 100 && newRating <= 110) {
                    playerCircle.classList.add('red');
                }
                
                const ratingDiv = document.createElement('div');
                ratingDiv.className = 'player-rating';
                ratingDiv.textContent = newRating;
                
                const nicknameDiv = document.createElement('div');
                nicknameDiv.className = 'player-nickname';
                nicknameDiv.textContent = player.nickname;
                
                playerCircle.appendChild(ratingDiv);
                playerCircle.appendChild(nicknameDiv);
                improvedPlayersContainer.appendChild(playerCircle);
            }
        }
    }
    
    // Показать оверлей
    document.getElementById('newSeasonOverlay').style.display = 'flex';
    document.getElementById('statsOverlay').style.display = 'none';
}

// Новая функция для продолжения после улучшения
function continueAfterSeason() {
    // Скрываем окно улучшения игроков
    document.getElementById('newSeasonOverlay').style.display = 'none';
    
    // Обновляем рейтинг команды после улучшений
    userTeamRating = calculateUserTeamRating();
document.getElementById('userRatingDisplay').textContent = userTeamRating;
    updateTeamSquadDisplay(); // Добавляем эту строку
updateTeamRatingCircle();
    
    // Сбрасываем турнирные данные для нового сезона
    currentRound = 256;
    usedOpponents = [];
    tournamentWon = false;
    
    // Сбрасываем состояние матча
    document.getElementById('matchOverlay').style.display = 'flex';
    document.getElementById('matchResult').textContent = '';
    document.getElementById('playButton').style.display = 'block';
    document.getElementById('backToMenuButton').style.display = 'none';
    document.getElementById('newSeasonButton').style.display = 'none';
    document.getElementById('scoreDisplay').textContent = '0 : 0';
    document.getElementById('eventsContainer').innerHTML = '';
    
    // Устанавливаем правильный раунд в интерфейсе
    const roundTitle = document.getElementById('roundTitle');
    roundTitle.innerHTML = `<h3>1/${currentRound} финала</h3>`;
    
    // Получаем нового соперника
    currentOpponent = getNextOpponent();
    usedOpponents.push(currentOpponent.name);
    
    // Обновляем интерфейс соперника
    document.getElementById('opponentLogo').src = currentOpponent.logo;
    document.getElementById('opponentName').textContent = currentOpponent.name;
    
    // Показываем четыре трансферных предложения
    showOffseasonTransfer.transferCount = 0; // Сбрасываем счетчик
    showOffseasonTransfer(); // Показываем первый трансфер
}

function showOffseasonTransfer() {
    // Инициализируем счетчик трансферов, если он еще не существует
    if (typeof showOffseasonTransfer.transferCount === 'undefined') {
        showOffseasonTransfer.transferCount = 0;
    }
    
    // Увеличиваем счетчик
    showOffseasonTransfer.transferCount++;
    
    // Если уже показали 4 трансфера, сбрасываем счетчик и начинаем новый сезон
    if (showOffseasonTransfer.transferCount > 4) {
        showOffseasonTransfer.transferCount = 0;
        nextMatch(); // Начинаем новый сезон
        return;
    }
    
    // Получаем случайную позицию из доступных
    const positionsList = Object.keys(positions);
    const randomPosition = positionsList[Math.floor(Math.random() * positionsList.length)];
    
    // Получаем текущего игрока на этой позиции
    const currentPlayer = positions[randomPosition].selected;
    
    if (!currentPlayer) {
        // Если почему-то нет игрока на этой позиции, пробуем снова
        setTimeout(showOffseasonTransfer, 0);
        return;
    }
    
    // Получаем случайного игрока на той же позиции (может быть любого рейтинга)
    const availablePlayers = positions[randomPosition].players.filter(
        p => p.nickname !== currentPlayer.nickname
    );
    
    if (availablePlayers.length === 0) {
        // Если нет других игроков на этой позиции, пробуем снова
        setTimeout(showOffseasonTransfer, 0);
        return;
    }
    
    const offeredPlayer = availablePlayers[Math.floor(Math.random() * availablePlayers.length)];
    
    // Обновляем интерфейс трансфера
    updateTransferUI(currentPlayer, offeredPlayer, randomPosition);
    
    // Меняем текст заголовка для межсезонья
    document.querySelector('.transfer-title').textContent = `Межсезонный трансфер (${showOffseasonTransfer.transferCount}/4)`;
    
    // Показываем модальное окно трансфера
    document.getElementById('transferOverlay').style.display = 'flex';
}


// Вынесем обновление UI в отдельную функцию
function updateTransferUI(currentPlayer, offeredPlayer, position) {
    const currentPlayerCircle = document.getElementById('currentPlayer');
    currentPlayerCircle.querySelector('.player-rating').textContent = currentPlayer.rating;
    currentPlayerCircle.querySelector('.player-nickname').textContent = currentPlayer.nickname;
    
    const offeredPlayerCircle = document.getElementById('offeredPlayer');
    offeredPlayerCircle.querySelector('.player-rating').textContent = offeredPlayer.rating;
    offeredPlayerCircle.querySelector('.player-nickname').textContent = offeredPlayer.nickname;
    
    // Устанавливаем классы рейтинга
    [currentPlayerCircle, offeredPlayerCircle].forEach(circle => {
        circle.className = 'player-circle';
        const rating = parseInt(circle.querySelector('.player-rating').textContent);
        if (rating >= 40 && rating <= 60) {
            circle.classList.add('bronze');
        } else if (rating >= 61 && rating <= 80) {
            circle.classList.add('silver');
        } else if (rating >= 81 && rating <= 99) {
            circle.classList.add('gold');
        } else if (rating >= 100 && rating <= 110) {
            circle.classList.add('red');
        }
    });
    
    // Сохраняем данные трансфера
    currentPlayerCircle.dataset.position = position;
    currentPlayerCircle.dataset.nickname = currentPlayer.nickname;
    offeredPlayerCircle.dataset.position = position;
    offeredPlayerCircle.dataset.nickname = offeredPlayer.nickname;
    offeredPlayerCircle.dataset.rating = offeredPlayer.rating;
}

function acceptTransfer() {
    const currentPlayerCircle = document.getElementById('currentPlayer');
    const offeredPlayerCircle = document.getElementById('offeredPlayer');
    
    const position = currentPlayerCircle.dataset.position;
    const oldNickname = currentPlayerCircle.dataset.nickname;
    const newNickname = offeredPlayerCircle.dataset.nickname;
    const newRating = parseInt(offeredPlayerCircle.dataset.rating);
    
    const offeredPlayer = positions[position].players.find(p => p.nickname === newNickname);
    
    if (offeredPlayer) {
        // Переносим часть статистики от старого игрока к новому (например, 50%)
        if (scorers[oldNickname]) {
            const oldGoals = scorers[oldNickname];
            scorers[newNickname] = Math.floor(oldGoals * 0.5); // Новый игрок получает 50% голов старого
            scorers[oldNickname] = Math.ceil(oldGoals * 0.5); // Старый игрок сохраняет 50%
        } else {
            scorers[newNickname] = 0;
        }
        
        positions[position].selected = offeredPlayer;
        userTeamRating = calculateUserTeamRating();
        document.getElementById('userRatingDisplay').textContent = userTeamRating;
        updateTeamSquadDisplay();
        updateTeamRatingCircle();
        updateTopScorersDisplay();
    }
    
    document.getElementById('transferOverlay').style.display = 'none';
    
    const isOffseasonTransfer = document.querySelector('.transfer-title').textContent.includes('Межсезонный');
    
    if (isOffseasonTransfer) {
        if (showOffseasonTransfer.transferCount < 4) {
            setTimeout(showOffseasonTransfer, 0);
        } else {
            nextMatch();
        }
    } else {
        setTimeout(nextMatch, 0);
    }
}

function rejectTransfer() {
    // Закрываем окно трансфера
    document.getElementById('transferOverlay').style.display = 'none';
    
    // Определяем, это обычный трансфер или межсезонный
    const isOffseasonTransfer = document.querySelector('.transfer-title').textContent.includes('Межсезонный');
    
    if (isOffseasonTransfer) {
        // Для межсезонных трансферов
        if (showOffseasonTransfer.transferCount < 4) {  // Изменили с 2 на 4
            setTimeout(showOffseasonTransfer, 0);
        } else {
            // После четырех межсезонных трансферов начинаем новый сезон
            nextMatch();
        }
    } else {
        // Для обычных трансферов просто продолжаем турнир
        setTimeout(nextMatch, 0);
    }
}

function updateTeamRatingCircle() {
    const teamCircle = document.getElementById('teamRatingCircle');
    if (!teamCircle) return;
    
    // Удаляем все классы цветов
    teamCircle.classList.remove('bronze', 'silver', 'gold', 'red');
    
    // Добавляем соответствующий класс в зависимости от рейтинга
    if (userTeamRating >= 40 && userTeamRating <= 60) {
        teamCircle.classList.add('bronze');
    } else if (userTeamRating >= 61 && userTeamRating <= 80) {
        teamCircle.classList.add('silver');
    } else if (userTeamRating >= 81 && userTeamRating <= 99) {
        teamCircle.classList.add('gold');
    } else if (userTeamRating >= 100 && userTeamRating <= 110) {
        teamCircle.classList.add('red');
    }
}

function updateTeamSquadDisplay() {
    const squadContainer = document.getElementById('teamSquadPlayers');
    squadContainer.innerHTML = '';
    
    for (const position in positions) {
        if (positions[position].selected) {
            const player = positions[position].selected;
            
            const playerWrapper = document.createElement('div');
            playerWrapper.className = 'squad-player';
            
            const playerCircle = document.createElement('div');
            playerCircle.className = 'squad-player-circle';
            
            // Добавляем класс цвета в зависимости от рейтинга
            if (player.rating >= 40 && player.rating <= 60) {
                playerCircle.classList.add('bronze');
            } else if (player.rating >= 61 && player.rating <= 80) {
                playerCircle.classList.add('silver');
            } else if (player.rating >= 81 && player.rating <= 99) {
                playerCircle.classList.add('gold');
            } else if (player.rating >= 100 && player.rating <= 110) {
                playerCircle.classList.add('red');
            }
            
            const ratingDiv = document.createElement('div');
            ratingDiv.className = 'squad-player-rating';
            ratingDiv.textContent = player.rating;
            
            const nicknameDiv = document.createElement('div');
            nicknameDiv.className = 'squad-player-nickname';
            nicknameDiv.textContent = player.nickname;
            
            playerCircle.appendChild(ratingDiv);
            playerWrapper.appendChild(playerCircle);
            playerWrapper.appendChild(nicknameDiv);
            
            squadContainer.appendChild(playerWrapper);
        }
    }
}

function updateTopScorersDisplay() {
    const scorersDisplay = document.getElementById('topScorersDisplay');
    
    // Преобразуем объект scorers в массив и сортируем по количеству голов
    const sortedScorers = Object.entries(allTimeScorers)
        .map(([name, goals]) => ({ name, goals }))
        .sort((a, b) => b.goals - a.goals);
    
    // Формируем HTML для отображения
    let html = '<div style="text-align: center; margin-bottom: 5px; color: #00bfff;">Бомбардиры (всё время)</div>';
    
    if (sortedScorers.length === 0) {
        html += '<div style="font-style: italic;">Голы еще не забиты</div>';
    } else {
        sortedScorers.forEach((scorer, index) => {
            // Выделяем текущих игроков команды
            const isCurrentPlayer = Object.values(positions).some(
                pos => pos.selected && pos.selected.nickname === scorer.name
            );
            
            const playerClass = isCurrentPlayer ? 'style="color: #7cfc00;"' : '';
            html += `<div ${playerClass}>${scorer.name}: ${scorer.goals}</div>`;
        });
    }
    
    scorersDisplay.innerHTML = html;
}
</script>

</body>
</html>
